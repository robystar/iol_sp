<plominodatabase id="iol_sp">
  <design>
    <resource id="ControllaZonaDaPosizione" title="Nuona trova tutte le zone" type="Script (Python)"><![CDATA[## Script (Python) "ControllaZonaDaPosizione"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=
##title=Nuona trova tutte le zone
##
from Products.CMFPlomino.PlominoUtils import json_dumps,json_loads

'''
doc=context.getDocument('01400-2019-dehor')
return context.trovaZona(doc.getItem('coord_lat'),doc.getItem('coord_lng'))
'''


for doc in context.getAllDocuments():
    res=[]
    infoZone=dict()
    if doc.getItem('coord_lat') and doc.getItem('coord_lng'):
        infoZone=json_loads(context.trovaZona(doc.getItem('coord_lat'),doc.getItem('coord_lng')))
        if infoZone.get("zona")!=doc.getItem('zona_cosap'):
            print doc.getId(), infoZone.get("zona"), doc.getItem('zona_cosap')

return printed















result = dict(success=1, cosap=0, allerta2=0, movida=0, zona="")


geom="SRID=4326;POINT(%s %s)" %(lng,lat)

res = context.getParentDatabase().resources.zsql.zsqlCategoriaCosap(geom = geom).dictionaries()
if len(res) == 1:
    result['success'] = 1
    result["cosap"] = res[0]['categoria']
    result["zona"] = res[0]['zona']
    
res = context.getParentDatabase().resources.zsql.zsqlAllerta2(geom = geom).dictionaries()
if len(res) == 1:
    result["allerta2"] = 1

res = context.getParentDatabase().resources.zsql.zsqlMovida(geom = geom).dictionaries()
if len(res) == 1:
    result["movida"] = 1
    
res = context.getParentDatabase().resources.zsql.zsqlKennedy(geom = geom).dictionaries()
if len(res) == 1:
    result["kennedy"] = 1
    
return json_dumps(result)
]]></resource>
  </design>
</plominodatabase>
