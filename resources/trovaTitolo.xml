<plominodatabase id="iol_sp">
  <design>
    <resource id="trovaTitolo" title="" type="Script (Python)"><![CDATA[## Script (Python) "trovaTitolo"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=numero='0',anno='2000'
##title=
##
from Products.CMFPlomino.PlominoUtils import StringToDate, DateToString, json_dumps
db=context.getParentDatabase()
index=db.getIndex()
'''
brains = index.dbsearch({"documento_esistente_titolo":int(numero),"documento_esistente_anno":int(anno)})
if len(brains)>0:
    doc=brains[0].getObject()
    if doc.getItem('morosi_opt')=='si':
        return json_dumps({"success":0,"message":"Attenzione, i pagamenti di COSAP o TARI non risultano essere in regola"})    
    elif doc.getItem('data_titolo'):
        return json_dumps({"success":0,"message":"Attenzione, l'autorizzazione indicata risulta gia' rinnovata con autorizzazione %s del %s. Non e' possibile continuare con la compilazione" %(doc.getItem('numero_titolo'),DateToString(doc.getItem('data_titolo'),format="%d/%m/%Y"))})
    elif doc.getItem('iol_tipo_app') in ['rinnovo-dehor','rinnovo-commercio']:
        return json_dumps({"success":0,"message":"Attenzione, esiste gia' una pratica di rinnovo in compilazione con identificativo %s. Continuare la compilazione o eliminarla." %(doc.getId())})
'''

brains = index.dbsearch({"numero_titolo":int(numero),"anno_titolo":int(anno)})
if len(brains)>0:
    doc=brains[0].getObject()
    if doc.getItem('morosi_opt')=='si':
        return json_dumps({"success":0,"message":"Attenzione:i pagamenti di COSAP e/o Tari gia' scaduti per l'anno 2019 non risultano in regola. Una volta regolarizzati presso Spezia Risorse sara' possibile procedere con il rinnovo"})
    else:
        return json_dumps({
            "success":1, 
            "message":"La pratica e' stata trovata, e' possibile continuare con la compilazione",
            "id":brains[0].id, 
            "pratica":doc.getItem('numero_pratica',brains[0].id), 
            "data":DateToString(doc.getItem('data_titolo'),format="%d/%m/%Y"),
            "anagrafica":doc.getItem('anagrafica_search')
            })
else:
    return json_dumps({"success":0,"message":"Attenzione, l'autorizzazione indicata non risulta presente in archivio oppure non si dispone dei diritti di accesso, verificare i dati inseriti. Non e' possibile continuare con la compilazione"})
]]></resource>
  </design>
</plominodatabase>
