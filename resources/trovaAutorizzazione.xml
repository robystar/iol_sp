<plominodatabase id="iol_sp">
  <design>
    <resource id="trovaAutorizzazione" title="" type="Script (Python)"><![CDATA[## Script (Python) "trovaAutorizzazione"
##bind container=container
##bind context=context
##bind namespace=
##bind script=script
##bind subpath=traverse_subpath
##parameters=numero='0',anno='2000'
##title=
##
from Products.CMFPlomino.PlominoUtils import StringToDate, DateToString, json_dumps
db=context.getParentDatabase()
index=db.getIndex()

brains = index.dbsearch({"documento_esistente_autorizzazione":int(numero),"documento_esistente_anno":int(anno)})
if len(brains)>0:
    doc=brains[0].getObject()
    if doc.getItem('morosi_opt')=='si':
        return json_dumps({"success":0,"message":"Attenzione, risultano pagamenti mancanti nell'anno precedente"})    
    elif doc.getItem('data_autorizzazione'):
        return json_dumps({"success":0,"message":"Attenzione, l'autorizzazione indicata risulta gia' rinnovata con autorizzazione %s del %s. Non e' possibile continuare con la compilazione" %(doc.getItem('numero_autorizzazione'),DateToString(doc.getItem('data_autorizzazione'),format="%d/%m/%Y"))})
    else:
        return json_dumps({"success":0,"message":"Attenzione, esiste gia' una pratica di rinnovo in compilazione con identificativo %s. Continuare la compilazione o eliminarla. <a href='%s/EditDocument?openwithform=frm_rinnovo'> Clicca qui per accedere alla pratica </a>" %(doc.getId(),doc.absolute_url())})


brains = index.dbsearch({"numero_autorizzazione":int(numero),"anno_autorizzazione":int(anno)})
if len(brains)>0:
    doc=brains[0].getObject()
    if doc.getItem('morosi_opt')=='si':
        return json_dumps({"success":0,"message":"Attenzione, risultano pagamenti mancanti nell'anno precedente"})
    else:
        return json_dumps({
            "success":1, 
            "message":"La pratica e' stata trovata, e' possibile continuare con la compilazione",
            "id":brains[0].id, 
            "pratica":doc.getItem('numero_pratica',brains[0].id), 
            #"data":DateToString(doc.getItem('data_titolo'),format="%d/%m/%Y"),
            #"anagrafica":doc.getItem('anagrafica_search')
            })
else:
    return json_dumps({"success":0,"message":"Attenzione, l'autorizzazione indicata non risulta presente in archivio oppure non si dispone dei diritti di accesso, verificare i dati inseriti. Non e' possibile continuare con la compilazione"})
]]></resource>
  </design>
</plominodatabase>
